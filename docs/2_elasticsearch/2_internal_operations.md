# Elasticsearch 내부 동작 원리

## 1. 샤드 (Shard)
### 기본 개념
- 인덱스가 저장되는 기본 단위
- 인덱스는 하나 이상의 샤드로 분산 저장

### 샤드 유형
1. 프라이머리 샤드
   - 데이터 원본 관리
   - 색인 작업 담당
   - 클러스터 핵심 데이터 저장
   - 인덱스 생성 시 한 번만 설정 가능

2. 레플리카 샤드
   - 데이터 복사본 관리
   - 읽기 요청 부하 분산
   - 데이터 손상 방지
   - 프라이머리 샤드 장애 시 승격
   - 동적 추가 가능

## 2. 확장 전략
### 스케일 업
- 하드웨어 업그레이드
- CPU, 메모리, 저장 공간 증설
- 물리적 한계와 비용 효율성 고려
- 샤드 성능 향상 중심

### 스케일 아웃
- 클러스터에 노드 추가
- 병렬 처리 능력 향상
- 데이터 분산 저장
- 클라우드 환경 적합
- 샤드 분산 및 장애 대비

## 3. 데이터 불변성
### 특징
- 색인 후 데이터 변경 불가
- 안정적인 데이터 보관
- 빠른 검색 성능
- 캐시 최적화
- 시스템 중단에도 데이터 보호

### 데이터 변경 처리
- 새로운 색인 추가로 변경 반영
- 기존 데이터 자동 제거
- Lock 알고리즘 불필요
- 무결성 유지

## 4. 세그먼트와 병합
### 세그먼트
- 불변성을 가진 저장 단위
- 키워드-문서 관계 매핑
- 실시간 데이터 색인 지원

### 세그먼트 병합
- 작은 세그먼트를 큰 세그먼트로 통합
- 디스크 공간 절약
- 검색 성능 향상
- 삭제된 문서 제거

## 5. Near Real Time (NRT)
### 특징
- 색인 후 1초 내외 검색 가능
- 실시간에 가까운 검색 제공
- 파일 시스템 캐시 활용

### 주요 프로세스
1. Refresh
   - 새 데이터를 인메모리 세그먼트로 이동
   - 1초 주기 자동 실행
   - 빠른 검색 결과 반영

2. Flush
   - 메모리 버퍼 데이터를 디스크에 저장
   - 데이터 영속성 보장
   - 트랜잭션 로그 관리

3. Translog
   - 임시 저장소 기능
   - 시스템 장애 시 복구
   - 노드 간 데이터 동기화
